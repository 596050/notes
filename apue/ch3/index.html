<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://notes.shichao.io/apue/ch3/">
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>Chapter 3. File I/O - Shichao's Notes</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">
        <link href="../../custom.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">Shichao's Notes</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="../..">Home</a>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">APUE <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../ch1/">Chapter 1. UNIX System Overview</a>
                        </li>
                    
                        <li >
                            <a href="../ch2/">Chapter 2. UNIX Standardization and Implementations</a>
                        </li>
                    
                        <li class="active">
                            <a href="./">Chapter 3. File I/O</a>
                        </li>
                    
                        <li >
                            <a href="../ch4/">Chapter 4. Files and Directories</a>
                        </li>
                    
                        <li >
                            <a href="../ch5/">Chapter 5. Standard I/O Library</a>
                        </li>
                    
                        <li >
                            <a href="../ch6/">Chapter 6. System Data Files and Information</a>
                        </li>
                    
                        <li >
                            <a href="../ch7/">Chapter 7. Process Environment</a>
                        </li>
                    
                        <li >
                            <a href="../ch8/">Chapter 8. Process Control</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">UTLK <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../utlk/ch1/">Chapter 1. Introduction</a>
                        </li>
                    
                        <li >
                            <a href="../../utlk/ch2/">Chapter 2. Memory Addressing</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">UNP <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../unp/ch1/">Chapter 1. Introduction</a>
                        </li>
                    
                        <li >
                            <a href="../../unp/ch2/">Chapter 2. The Transport Layer: TCP, UDP, and SCTP</a>
                        </li>
                    
                        <li >
                            <a href="../../unp/ch3/">Chapter 3. Sockets Introduction</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">ICND <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../icnd1/part1/">ICND1 Part I: Networking Fundamentals</a>
                        </li>
                    
                        <li >
                            <a href="../../icnd2/part1/">ICND2 Part I: LAN Switching</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">TCPv1 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../tcpv1/ch1/">Chapter 1. Introduction</a>
                        </li>
                    
                        <li >
                            <a href="../../tcpv1/ch2/">Chapter 2. The Internet Address Architecture</a>
                        </li>
                    
                        <li >
                            <a href="../../tcpv1/ch10/">Chapter 10. User Datagram Protocol (UDP) and IP Fragmentation</a>
                        </li>
                    
                        <li >
                            <a href="../../tcpv1/headers/">Headers</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Others <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../htae/">HTAE</a>
                        </li>
                    
                        <li >
                            <a href="../../golang/">Go</a>
                        </li>
                    
                        <li >
                            <a href="../../bash/">Bash</a>
                        </li>
                    
                        <li >
                            <a href="../../c/">C</a>
                        </li>
                    
                        <li >
                            <a href="../../iptables/">iptables</a>
                        </li>
                    
                        <li >
                            <a href="../../nginx/">Nginx</a>
                        </li>
                    
                        <li >
                            <a href="../../vim/">Vim</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
                <li>
                    <a href="https://github.com/shichao-an/notes">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#chapter-3-file-io">Chapter 3. File I/O</a></li>
        
    
        <li class="main "><a href="#file-descriptors">File Descriptors</a></li>
        
    
        <li class="main "><a href="#open-and-openat-functions">open and openat Functions</a></li>
        
            <li><a href="#tocttou">TOCTTOU</a></li>
        
    
        <li class="main "><a href="#filename-and-pathname-truncation">Filename and Pathname Truncation</a></li>
        
    
        <li class="main "><a href="#creat-function">creat Function</a></li>
        
    
        <li class="main "><a href="#close-function">close Function</a></li>
        
    
        <li class="main "><a href="#lseek-function">lseek Function</a></li>
        
    
        <li class="main "><a href="#read-function">read Function</a></li>
        
    
        <li class="main "><a href="#write-function">write Function</a></li>
        
    
        <li class="main "><a href="#io-efficiency">I/O Efficiency</a></li>
        
    
        <li class="main "><a href="#file-sharing">File Sharing</a></li>
        
            <li><a href="#specific-operations">Specific operations</a></li>
        
            <li><a href="#file-descriptor-flags-vs-the-file-status-flags">File descriptor flags vs. the file status flags</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h3 id="chapter-3-file-io"><strong>Chapter 3. File I/O</strong></h3>
<p>This chapter discusses unbuffered I/O, which are not part of ISO C but are part of POSIX.1 and the Single UNIX Specification.</p>
<h3 id="file-descriptors">File Descriptors</h3>
<ul>
<li>All open files are referred to by file descriptors</li>
<li>Non-negative integer</li>
<li>Range from 0 to <code>OPEN_MAX - 1</code>. With FreeBSD 8.0, Linux 3.2.0, Mac OS X 10.6.8, and Solaris 10, the limit is essentially infinite, bounded by the amount of memory on the system, the size of an integer, and any hard and soft limits configured by the system administrator.</li>
</ul>
<h3 id="open-and-openat-functions"><code>open</code> and <code>openat</code> Functions</h3>
<script src="https://gist.github.com/shichao-an/84b85f42bf03c30fa75b.js"></script>

<p><code>oflag</code> argument is formed by ORing one or more of the following constants from <code>&lt;fcntl.h&gt;</code> [p62]:</p>
<p>Required:</p>
<ul>
<li><code>O_RDONLY</code></li>
<li><code>O_WRONLY</code></li>
<li><code>O_RDWR</code></li>
<li><code>O_EXEC</code></li>
<li><code>O_SEARCH</code>: Open for search only (applies to directories).</li>
</ul>
<p>Optional:</p>
<ul>
<li><code>O_APPEND</code></li>
<li><code>O_CLOEXEC</code>: Set the <a href="https://www.gnu.org/software/libc/manual/html_node/Descriptor-Flags.html"><code>FD_CLOEXEC</code></a> file descriptor flag</li>
<li><code>O_CREAT</code>: Create the file if it doesn’t exist</li>
<li><code>O_DIRECTORY</code>: Generate an error if <code>O_CREAT</code> is also specified and the file already exists. This test for whether the file already exists and the creation of the file if it doesn’t exist is an atomic operation</li>
<li><code>O_EXCL</code></li>
<li><code>O_NOCTTY</code></li>
<li><code>O_NOFOLLOW</code></li>
<li><code>O_NONBLOCK</code></li>
<li><code>O_SYNC</code>: Have each <code>write</code> wait for physical I/O to complete</li>
<li><code>O_TRUNC</code></li>
<li><code>O_TTY_INIT</code></li>
<li><code>O_DSYNC</code></li>
<li><code>O_RSYNC</code></li>
</ul>
<h4 id="tocttou">TOCTTOU</h4>
<p><code>openat</code>, for example, provides a way to avoid <a href="http://en.wikipedia.org/wiki/Time_of_check_to_time_of_use">time-of-check-to-time-of-use</a> (TOCTTOU) errors. A program is vulnerable if it makes two file-based function calls where the second call depends on the results of the first call (two calls are not atomic).</p>
<h3 id="filename-and-pathname-truncation">Filename and Pathname Truncation</h3>
<p>Most modern file systems support a maximum of 255 characters for filenames.</p>
<h3 id="creat-function"><code>creat</code> Function</h3>
<script src="https://gist.github.com/shichao-an/e0ac0fe91b023280e33f.js"></script>

<p>This function is equivalent to:</p>
<pre><code class="c">open(path, O_WRONLY | O_CREAT | O_TRUNC, mode);
</code></pre>

<p>With <code>creat</code>, the file is opened only for writing. To read and write a file, use [p66]:</p>
<pre><code class="c">open(path, O_RDWR | O_CREAT | O_TRUNC, mode);
</code></pre>

<h3 id="close-function"><code>close</code> Function</h3>
<script src="https://gist.github.com/shichao-an/84758a089b6cb82b7495.js"></script>

<p>When a process terminates, all of its open files are closed automatically by the kernel. Many programs take advantage of this fact and don’t explicitly close open files.</p>
<h3 id="lseek-function"><code>lseek</code> Function</h3>
<p>Every open file has a "current file offset", normally a non-negative integer that measures the number of bytes from the beginning of the file.</p>
<script src="https://gist.github.com/shichao-an/b9b0bc7d6dca91b7afd6.js"></script>

<p>The <em>whence</em> argument can be:</p>
<ul>
<li><code>SEEK_SET</code>: the file’s offset is set to <em>offset</em> bytes from the beginning of the file</li>
<li><code>SEEK_CUR</code>: the file’s offset is set to its current value plus the <em>offset</em>. The <em>offset</em> can be positive or negative.</li>
<li><code>SEEK_END</code>: the file’s offset is set to the size of the file plus the <em>offset</em>. The <em>offset</em> can be positive or negative.</li>
</ul>
<p>To determine the current offset, <u>seek zero bytes from the current position</u>:</p>
<pre><code class="c">off_t currpos;
currpos = lseek(fd, 0, SEEK_CUR);
</code></pre>

<p>This technique (above code) can also be used to determine if a file is capable of seeking. If the file descriptor refers to a pipe, FIFO, or socket, <code>lseek</code> sets <code>errno</code> to <code>ESPIPE</code> and returns −1.</p>
<ul>
<li>Negative offsets are possible for certain devices, but for regular files, the offset must be non-negative.</li>
<li><code>lseek</code> only records the current file offset within the kernel and does not cause any I/O to take place. This offset is then used by the next read or write operation.</li>
<li>Hole in a file: file’s offset can be greater than the file’s current size, in which case the next <code>write</code> to the file will extend the file. This creates a hole in the file.<ul>
<li>Bytes in the hole (bytes that have not been writen) are read back as 0. </li>
<li>A hole in a file isn’t required to have storage backing it on disk.</li>
</ul>
</li>
</ul>
<h3 id="read-function"><code>read</code> Function</h3>
<script src="https://gist.github.com/shichao-an/ed695671abeb99a2a4b4.js"></script>

<ul>
<li><em>buf</em>: type <code>void *</code> is used for generic pointers.</li>
<li>Return value is required to be a signed integer (<code>ssize_t</code>) to return a positive byte count, 0 (for end of file), or −1 (for an error).</li>
</ul>
<p>Several cases in which the number of bytes actually read is less than the amount requested:</p>
<ul>
<li>Regular file: if the end of file is reached before the requested number of bytes has been read.</li>
<li>Terminal device: up to one line is read at a time</li>
<li>Network: buffering within the network may cause less than the requested amount to be returned</li>
<li>Pipe or FIFO: if the pipe contains fewer bytes than requested, <code>read</code> will return only what is available</li>
<li>Record-oriented device</li>
<li>Interrupted by a signal and a partial amount of data has already been read</li>
</ul>
<h3 id="write-function"><code>write</code> Function</h3>
<script src="https://gist.github.com/shichao-an/dc05a71e1e7eb4c18a0f.js"></script>

<p>The return value is usually equal to the <em>nbytes</em> argument; otherwise, an error has occurred. </p>
<p>Common causes for a <code>write</code> error: </p>
<ul>
<li>Filling up a disk</li>
<li>Exceeding the file size limit for a given process</li>
</ul>
<p>For a regular file, the write operation starts at the file’s current offset. If the <code>O_APPEND</code> option was specified when the file was opened, the file’s offset is set to the current end of file before each write operation. After a successful write, the file’s offset is incremented by the number of bytes actually written.</p>
<h3 id="io-efficiency">I/O Efficiency</h3>
<ul>
<li><a href="https://github.com/shichao-an/apue.3e/blob/master/fileio/mycat.c">mycat.c</a></li>
</ul>
<pre><code class="c">#include &quot;apue.h&quot;

#define BUFFSIZE 4096

int
main(void)
{
    int n;
    char buf[BUFFSIZE];

    while ((n = read(STDIN_FILENO, buf, BUFFSIZE)) &gt; 0)
    if (write(STDOUT_FILENO, buf, n) != n)
        err_sys(&quot;write error&quot;);

    if (n &lt; 0)
        err_sys(&quot;read error&quot;);

    exit(0);
}
</code></pre>

<p>Caveats of the above program:</p>
<ul>
<li>It reads from standard input and writes to standard output, assuming that these have been set up by the shell before this program is executed.</li>
<li>It doesn’t close the input file or output file. Instead, the program uses the feature of the <u>UNIX kernel that closes all open file descriptors in a process when that process terminates.</u></li>
<li>This example works for both text files and binary files, since there is no difference between the two to the UNIX kernel.</li>
</ul>
<p>Timing results for reading with different buffer sizes (<code>BUFFSIZE</code>) on Linux:</p>
<p><a href="../figure_3.6.png" title="Figure 3.6 Timing results for reading with different buffer sizes on Linux"><img alt="Figure 3.6 Timing results for reading with different buffer sizes on Linux" src="../figure_3.6_600.png" /></a></p>
<p>The file was read using the program shown above, with standard output redirected to <code>/dev/null</code>. The file system used for this test was the Linux ext4 file system with 4,096-byte blocks (the <code>st_blksize</code> value is 4,096). This accounts for the minimum in the system time occurring at the few timing measurements starting around a <code>BUFFSIZE</code> of 4,096. Increasing the buffer size beyond this limit has little positive effect.</p>
<p>Most file systems support some kind of read-ahead to improve performance. When sequential reads are detected, the system tries to read in more data than an application requests, assuming that the application will read it shortly. The effect of read-ahead can be seen in Figure 3.6, where the elapsed time for buffer sizes as small as 32 bytes is as good as the elapsed time for larger buffer sizes. [p73]</p>
<h3 id="file-sharing">File Sharing</h3>
<p>The UNIX System supports the sharing of open files among different processes.</p>
<p><a href="../figure_3.7.png" title="Figure 3.7 Kernel data structures for open files"><img alt="Figure 3.7 Kernel data structures for open files" src="../figure_3.7_600.png" /></a></p>
<p>The kernel uses three data structures to represent an open file, and the relationships among them determine the effect one process has on another with regard to file sharing.</p>
<ul>
<li><strong>Process table entry</strong>: every process has an entry in the process table. Each process table entry has a table of open file descriptors. Associated with each file descriptor are:<ul>
<li><a href="http://www.gnu.org/software/libc/manual/html_node/Descriptor-Flags.html"><strong>File descriptor flags</strong></a> (close-on-exec)</li>
<li>Pointer to a file table entry:</li>
</ul>
</li>
<li><strong>File table entry</strong>: the kernel maintains a file table for all open files. Each file table entry contains:<ul>
<li><a href="http://www.gnu.org/software/libc/manual/html_node/File-Status-Flags.html"><strong>File status flags</strong></a></li>
<li>Current file offset</li>
<li>Pointer to the v-node table entry for the file</li>
</ul>
</li>
<li><strong>v-node</strong> structure: contains information about the type of file and pointers to functions that operate on the file<ul>
<li>This information is read from disk when the file is opened, so that all the pertinent information about the file is readily available</li>
<li>v-node also contains the <strong>i-node</strong> for the file</li>
<li>Linux has no v-node. Instead, a generic i-node structure is used. [p75] Instead of splitting the data structures into a v-node and an i-node, Linux uses a file system–independent i-node and a file system–dependent i-node. [p76]</li>
</ul>
</li>
</ul>
<p><a href="../../apue/figure_3.7.png">Figure 3.7</a> shows a pictorial arrangement of these three tables for a single process that has two different files open: one file is open on standard input (file descriptor 0), and the other is open on standard output (file descriptor 1).</p>
<p>If two independent processes have the same file open, we could have the arrangement shown in Figure 3.8 (below).</p>
<p><a href="../figure_3.8.png" title="Figure 3.8 Two independent processes with the same file open"><img alt="Figure 3.8 Two independent processes with the same file open" src="../figure_3.8_600.png" /></a></p>
<p>Each process that opens the file gets its own file table entry, but only a single v-node table entry is required for a given file. One reason <u>each process gets its own file table entry is so that each process has its own current offset for the file.</u></p>
<h4 id="specific-operations">Specific operations</h4>
<ul>
<li>File offset: After each <code>write</code> is complete, the current file offset in the file table entry is incremented by the number of bytes written. If this causes the current file offset to exceed the current file size, the current file size in the i-node table entry is set to the current file offset (the file is extended).</li>
<li><code>O_APPEND</code>: If a file is opened with the <code>O_APPEND</code> flag, a corresponding flag is set in the file status flags of the file table entry. Each time a <code>write</code> is performed for a file with this append flag set, the current file offset in the file table entry is first set to the current file size from the i-node table entry. Th is forces every <code>write</code> to be appended to the current end of file.</li>
<li><code>lseek</code><ul>
<li>If a file is positioned to its current end of file using <code>lseek</code>, all that happens is the current file offset in the file table entry is set to the current file size from the i-node table entry. <u>This is not the same as if the file was opened with the <code>O_APPEND</code> flag.</u></li>
<li>The <code>lseek</code> function modifies only the current file offset in the file table entry. No I/O takes place.</li>
</ul>
</li>
</ul>
<p>It is possible for more than one file descriptor entry to point to the same file table entry:</p>
<ul>
<li><code>dup</code></li>
<li><code>fork</code>: the parent and the child share the same file table entry for each open descriptor</li>
</ul>
<h4 id="file-descriptor-flags-vs-the-file-status-flags">File descriptor flags vs. the file status flags</h4>
<ul>
<li>File descriptor flags: apply only to a single descriptor in a single process</li>
<li>File status flags: apply to all descriptors in any process that point to the given file table entry</li>
<li><code>fcntl</code> is used to fetch and modify both of them</li>
</ul></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
            <center>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</center>
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script src="../../js/base.js"></script>
    </body>
</html>